#-------------------------------------------------------------------------------
# Workflow configuration
#-------------------------------------------------------------------------------

name: "Binary build"
on:
  release:
    types: [published]
  push:
    paths:
      - ".github/workflows/build.yaml"
      - "Cargo.toml"
      - "crates/**"
      - "macos/**"
      - "windows/**"
      - "deployments/**"
      - "freedesktop/**"
  pull_request_review:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

#-------------------------------------------------------------------------------
# Workflow jobs
#-------------------------------------------------------------------------------

jobs:
  build-android-cli:
    name: "Build for Android (aarch64) for terminal"
    if: false  
    # Temporarily disable this job
    # To re-enable, change 'false' to 'true' or remove this line
    runs-on: ubuntu-22.04
    steps:
      # 1. Checkout 代码（含子模块）
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      # 2. 获取 Git 版本号
      - name: Get git version
        id: git_tag_version
        run: |
          # 如果是 tag 直接使用，否则用 latest
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            BUILD_VERSION=$(echo $GITHUB_REF | sed 's|refs/tags/||')
          else
            BUILD_VERSION="latest"
          fi
          echo "Build version: $BUILD_VERSION"
          echo "BUILD_VERSION=$BUILD_VERSION" >> $GITHUB_OUTPUT

      # 3. 安装系统依赖
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build pkg-config

      # 4. 下载并安装 Android NDK
      - name: Download and setup Android NDK
        run: |
          echo "Downloading Android NDK..."
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux.zip -O ndk.zip
          unzip -q ndk.zip
          mv android-ndk-r26b /opt/android-ndk
          echo "NDK installed to /opt/android-ndk"

          # 将 NDK 添加到 PATH
          echo "/opt/android-ndk" >> $GITHUB_PATH
          echo "/opt/android-ndk/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      # 5. 安装 Rust 目标和 cargo-ndk
      - name: Install Rust target and cargo-ndk
        run: |
          rustup target install aarch64-linux-android
          cargo install cargo-ndk

      # 6. 使用 cargo-ndk 构建 Android 二进制
      - name: Build for Android (arm64-v8a)
        run: |
          cargo ndk -t arm64-v8a build --release -p wsrx

      # 7. 打包二进制文件
      - name: Package binary
        run: |
          mkdir -p release
          cp target/aarch64-linux-android/release/wsrx release/wsrx-android-aarch64
          tar -czf wsrx-cli-${{ steps.git_tag_version.outputs.BUILD_VERSION }}-android-aarch64.tar.gz -C release .
          echo "Package created: wsrx-cli-${{ steps.git_tag_version.outputs.BUILD_VERSION }}-android-aarch64.tar.gz"

      # 8. 上传为 Artifact（每次构建都保留）
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wsrx-cli-android-aarch64-${{ steps.git_tag_version.outputs.BUILD_VERSION }}
          path: wsrx-cli-${{ steps.git_tag_version.outputs.BUILD_VERSION }}-android-aarch64.tar.gz

      # 9. 发布到 GitHub Release（仅在 tag 时触发）
      - name: Release to GitHub
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: "Automated release of `wsrx` CLI for Android (aarch64)."
          files: wsrx-cli-${{ steps.git_tag_version.outputs.BUILD_VERSION }}-android-aarch64.tar.gz
          draft: false
          prerelease: false

  build-android-gui:
    name: "Build Android GUI App"
    runs-on: ubuntu-22.04
    steps:
      # Checkout repository (and submodules)
      - name: Checkout repository (and submodules)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      # Get current git tag version
      - name: Get git version
        id: git_tag_version
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            BUILD_VERSION=$(echo $GITHUB_REF | sed 's|refs/tags/||')
          else
            BUILD_VERSION="latest"
          fi
          echo "Build at version $BUILD_VERSION"
          echo "BUILD_VERSION=$BUILD_VERSION" >> $GITHUB_OUTPUT

      # Setup Java 17 (required for recent Android SDK tools)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # --- MANUAL SDK/NDK INSTALLATION ---
      # Instead of relying on android-actions/setup-android for installation,
      # we download and set up SDK/NDK manually to ensure completeness.
      - name: Install Android SDK Command-line Tools and NDK manually
        run: |
          # Define versions and paths
          SDK_TOOLS_VERSION="11076708" # cmdline-tools version
          NDK_VERSION="25.1.8937393"
          ANDROID_HOME="$HOME/android-sdk"
          SDK_TOOLS_ZIP="commandlinetools-linux-${SDK_TOOLS_VERSION}_latest.zip"
          NDK_ZIP="android-ndk-${NDK_VERSION}-linux.zip"

          echo "ANDROID_HOME will be: $ANDROID_HOME"

          # Create SDK directory
          mkdir -p "$ANDROID_HOME"

          # --- Install Command-line Tools ---
          echo "Downloading Android SDK Command-line Tools..."
          wget -q "https://dl.google.com/android/repository/${SDK_TOOLS_ZIP}" -O "$HOME/sdk-tools.zip"
          echo "Extracting SDK Command-line Tools..."
          # Extract to a temporary location first
          mkdir -p "$HOME/sdk-tmp"
          unzip -q "$HOME/sdk-tools.zip" -d "$HOME/sdk-tmp"
          # Move 'cmdline-tools' directory into SDK root correctly
          # It should be $ANDROID_HOME/cmdline-tools/latest/
          mkdir -p "$ANDROID_HOME/cmdline-tools"
          mv "$HOME/sdk-tmp/cmdline-tools" "$ANDROID_HOME/cmdline-tools/latest"
          rm -f "$HOME/sdk-tools.zip"
          rm -rf "$HOME/sdk-tmp"

          # Add tools to PATH for this session and future steps
          export PATH="$ANDROID_HOME/cmdline-tools/latest/bin:$PATH"
          echo "PATH=$PATH" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV

          # Accept licenses
          echo "Accepting Android SDK licenses..."
          yes | "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" --licenses >/dev/null 2>&1 || true # Ignore potential non-zero exit

          # --- Install essential SDK packages ---
          echo "Installing essential SDK packages (platform-tools, platforms, build-tools)..."
          "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" \
            "platform-tools" \
            "platforms;android-33" \
            "build-tools;33.0.2" \
            > /dev/null
          # Suppress output to reduce log size

          # --- Install NDK ---
          echo "Downloading Android NDK $NDK_VERSION..."
          wget -q "https://dl.google.com/android/repository/${NDK_ZIP}" -O "$HOME/ndk.zip"
          echo "Extracting Android NDK..."
          unzip -q "$HOME/ndk.zip" -d "$HOME"
          # Move NDK to standard location within SDK
          mv "$HOME/android-ndk-${NDK_VERSION}" "$ANDROID_HOME/ndk/${NDK_VERSION}"
          rm -f "$HOME/ndk.zip"

          # Set NDK environment variables
          echo "ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/${NDK_VERSION}" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${NDK_VERSION}" >> $GITHUB_ENV

          # Explicitly unset ANDROID_SDK_ROOT to avoid deprecation warning and conflicts
          echo "ANDROID_SDK_ROOT=" >> $GITHUB_ENV

          # Verify key files exist
          if [ ! -f "$ANDROID_HOME/source.properties" ]; then
            # The root SDK directory might not have source.properties, but cmdline-tools or packages might.
            # Let's check a core installed component.
            if [ -f "$ANDROID_HOME/platform-tools/source.properties" ]; then
                echo "::notice::SDK source.properties found in platform-tools."
            else
                echo "::warning::source.properties not found in expected SDK locations. This might still cause issues."
            fi
          else
            echo "::notice::SDK source.properties found in root."
          fi

          if [ ! -f "$ANDROID_HOME/ndk/${NDK_VERSION}/source.properties" ]; then
              echo "::error::NDK source.properties NOT found! Installation likely failed."
              ls -la "$ANDROID_HOME/ndk/${NDK_VERSION}/" || echo "NDK directory listing failed."
              exit 1
          else
              echo "::notice::NDK source.properties found."
          fi

          if [ ! -d "$ANDROID_HOME/build-tools" ]; then
              echo "::error::build-tools directory NOT found! SDK installation likely failed."
              ls -la "$ANDROID_HOME/" || echo "SDK root directory listing failed."
              exit 1
          else
              echo "::notice::build-tools directory found."
          fi

          echo "::notice::Manual SDK/NDK installation and configuration completed successfully."

      # --- END MANUAL SDK/NDK INSTALLATION ---

      # Install system dependencies for GUI building
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake \
            ninja-build \
            pkg-config \
            imagemagick \
            libfontconfig1-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxi-dev

      # Install Rust and Android targets
      - name: Install Rust and Android targets
        run: |
          rustup update stable && rustup default stable
          rustup target add aarch64-linux-android armv7-linux-androideabi

      # Install cargo-apk
      - name: Install cargo-apk
        run: |
          cargo install cargo-apk

      # Build APK for aarch64 (ARM64)
      - name: Build APK for aarch64
        run: |
          cd crates/desktop
          cargo apk build --release --target aarch64-linux-android
        # Environment variables are now set in GITHUB_ENV

      # Build APK for armv7 (ARM32)
      - name: Build APK for armv7
        run: |
          cd crates/desktop
          cargo apk build --release --target armv7-linux-androideabi
        # Environment variables are now set in GITHUB_ENV

      # Find and rename APKs with version
      - name: Find and rename APKs
        run: |
          mkdir -p release

          echo "🔍 Searching for APK files..."
          find . -name "*.apk" -type f | while read apk; do
            echo "Found APK: $apk"
            echo "Size: $(du -h "$apk" | cut -f1)"
          done

          # Find ARM64 APK
          ARM64_APK=$(find crates/desktop/target/aarch64-linux-android -name "*.apk" -type f | head -1)
          if [ -n "$ARM64_APK" ]; then
            cp "$ARM64_APK" "release/WebSocketReflectorX-${{ steps.git_tag_version.outputs.BUILD_VERSION }}-android-arm64-v8a.apk"
            echo "✅ ARM64 APK: $ARM64_APK"
          else
            echo "❌ ARM64 APK not found"
          fi

          # Find ARM32 APK
          ARM32_APK=$(find crates/desktop/target/armv7-linux-androideabi -name "*.apk" -type f | head -1)
          if [ -n "$ARM32_APK" ]; then
            cp "$ARM32_APK" "release/WebSocketReflectorX-${{ steps.git_tag_version.outputs.BUILD_VERSION }}-android-armeabi-v7a.apk"
            echo "✅ ARM32 APK: $ARM32_APK"
          else
            echo "❌ ARM32 APK not found"
          fi

          # List generated files for debugging
          echo "📦 Generated APK files:"
          ls -la release/ || echo "No files in release directory"

      # Upload APKs as artifacts
      - name: Upload APKs (Artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: android-gui-apks-${{ steps.git_tag_version.outputs.BUILD_VERSION }}
          path: release/*.apk

      # Upload to GitHub Release
      - name: Release to GitHub
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            release/WebSocketReflectorX-${{ steps.git_tag_version.outputs.BUILD_VERSION }}-android-arm64-v8a.apk
            release/WebSocketReflectorX-${{ steps.git_tag_version.outputs.BUILD_VERSION }}-android-armeabi-v7a.apk
